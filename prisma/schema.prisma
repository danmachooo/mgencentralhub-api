generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Better Auth Model

model User {
  id            String   @id
  name          String
  email         String
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions Session[]
  accounts Account[]

  profile UserProfile?

  createdSystems          System[]                     @relation("SystemCreator")
  personalSystems         PersonalSystem[]             @relation("PersonalSystemOwner")
  favoriteSystems         UserFavoriteSystem[]
  favoritePersonalSystems UserFavoritePersonalSystem[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// Project related

model Role {
  id          String @id @default(uuid()) @db.Uuid
  name        String
  description String @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime?

  // FIX: one role -> many user profiles
  userProfiles UserProfile[]

  @@unique([name])
  @@index([deletedAt])
  @@map("user_roles")
}

model UserProfile {
  userId       String  @id @map("user_id")
  departmentId String? @map("department_id") @db.Uuid
  roleId       String  @map("role_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  role       Role        @relation(fields: [roleId], references: [id], onDelete: Restrict)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  @@index([roleId])
  @@index([departmentId])
  @@map("user_profiles")
}

model SystemFlag {
  id          String @id @default(uuid()) @db.Uuid
  key         String
  name        String
  description String @db.Text

  system System[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime?

  @@unique([key])
  @@unique([name])
  @@index([deletedAt])
  @@map("system_flags")
}

model System {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  description String? @db.Text
  image       String?
  url         String
  statusId    String  @db.Uuid

  creatorId  String     @map("creator_id")
  systemFlag SystemFlag @relation(fields: [statusId], references: [id])
  creator    User       @relation("SystemCreator", fields: [creatorId], references: [id], onDelete: Restrict)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime?

  departmentMap SystemDepartmentMap[]
  favorites     UserFavoriteSystem[]

  @@unique([url])
  @@unique([name])
  @@index([creatorId])
  @@index([statusId])
  @@index([deletedAt])
  @@map("systems")
}

model Department {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  description String? @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime?

  systemMap    SystemDepartmentMap[]
  userProfiles UserProfile[]

  @@unique([name])
  @@index([deletedAt])
  @@map("departments")
}

model SystemDepartmentMap {
  systemId     String @map("system_id") @db.Uuid
  departmentId String @map("department_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  system     System     @relation(fields: [systemId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@id([systemId, departmentId])
  @@index([departmentId])
  @@map("system_department_map")
}

model PersonalSystem {
  id          String @id @default(uuid()) @db.Uuid
  ownerUserId String @map("owner_user_id")

  name        String
  description String? @db.Text
  image       String?
  url         String

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime?

  owner     User                         @relation("PersonalSystemOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  favorites UserFavoritePersonalSystem[]

  @@unique([ownerUserId, url])
  @@index([ownerUserId])
  @@index([deletedAt])
  @@map("personal_systems")
}

model UserFavoriteSystem {
  userId   String @map("user_id")
  systemId String @map("system_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  system System @relation(fields: [systemId], references: [id], onDelete: Cascade)

  @@id([userId, systemId])
  @@index([systemId])
  @@map("user_favorite_systems")
}

model UserFavoritePersonalSystem {
  userId           String @map("user_id")
  personalSystemId String @map("personal_system_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  personalSystem PersonalSystem @relation(fields: [personalSystemId], references: [id], onDelete: Cascade)

  @@id([userId, personalSystemId])
  @@index([personalSystemId])
  @@map("user_favorite_personal_systems")
}
